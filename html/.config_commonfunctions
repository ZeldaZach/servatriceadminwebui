<?php
	$configfile = ".config";

	function insert_avatar($image,$username){
		$results = "unknown";
		$configfile = ".config";
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
		
		//read in image file
		$fp = fopen($image, 'r');
	  	$data = fread($fp, filesize($image));
  		$data = addslashes($data);
  		fclose($fp);
		
		//establish db connection
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		//insert image into database
		$query = mysql_query("UPDATE " . $dbtable . " SET avatar_bmp='" . $data . "' WHERE name='" . $username . "'");
		$results = $query;
                mysql_close($dbconnection);
                return $results;	
	}

	function connect_to_database($dbserver,$dbuser,$dbpass,$dbname){
       	        $results = 'unknown';
               	if ($dbserver == ''){ $results = 'failed, database server name can not be blank'; return $results; exit; }
       	        if ($dbuser == ''){ $results = 'failed, database user name can not be blank'; return $results; exit; }
               	if ($dbname == ''){ $results = 'failed, database user password can not be blank'; return $results; exit; }
		$connection = mysql_connect(trim($dbserver),trim($dbuser),trim($dbpass));
		if (!$connection){ $results = "failed, " . mysql_error(); return results; exit; }
       	        $database = mysql_select_db(trim($dbname),$connection);
                if ($database){ return $connection; exit; }
       	        if (!$database){ $results = "failed, " . mysql_error(); return $results; exit; }
       	}

	function crypt_password($password, $salt = ''){
                if ($salt == '') {
       	                $saltChars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
                        for ($i = 0; $i < 16; ++$i)
       	                $salt .= $saltChars[rand(0, strlen($saltChars) - 1)];
                }
       	        $key = $salt . $password;
                for ($i = 0; $i < 1000; ++$i)
               	$key = hash('sha512', $key, true);
       	        return $salt . base64_encode($key);
        }

	function get_config_value($configfile,$configvalue){
		$results = "unknown";
		if (empty($configfile)){ $results = "failed, config file name can not be blank"; return $results; exit;}
		if (empty($configvalue)){ $results = "failed, config file value can not be blank"; return $results; exit;}
		if (!file_exists($configfile)){ $results = "failed, config file does not exist"; return $results; exit;}
		$file_handle = fopen($configfile, "r");
		while (!feof($file_handle)) {
			$line = fgets($file_handle);
			if (strpos($line,$configvalue) !== false){
				$lineparts = explode("=",$line);
				if (sizeof($lineparts) < 3 && sizeof($lineparts) > 1){ $results = $lineparts[1];}
			}
		}
		fclose($file_handle);
		return trim($results);
	}
	
	function close_complaint($moderator,$id,$verdict){
                global $configfile;
		$closedate = date("Y-m-d H:i:s");
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbcoctable");
                if (empty($moderator)){ $results = "failed, moderator name can not be blank"; return $results; exit; }
                if (empty($id)){ $results = "failed, id can not be blank"; return $results; exit; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("UPDATE " . trim($dbtable) . " SET closingmod='" . trim($moderator) . "', dateresolved='" . $closedate . "', closingverdict='" . $verdict . "' WHERE id='" . trim($id) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                $results = $query;
                mysql_close($dbconnection);
                return $results;
        }

	function delete_complaint($id){
		global $configfile;
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbcoctable");
		if (empty($id)){ $results = "failed, message id can not be blank"; return $results; exit; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("DELETE FROM " . trim($dbtable) . " WHERE id='" . trim($id) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                $results = $query;
                mysql_close($dbconnection);
                return $results;
	}

	function update_complaint_modnotes($notes,$id){
		global $configfile;
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbcoctable");
		if (empty($notes)){ $results = "failed, notes can not be blank"; return $results; exit; }
		if (empty($id)){ $results = "failed, id can not be blank"; return $results; exit; }
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("UPDATE " . trim($dbtable) . " SET modnotes='" . trim($notes) . "' WHERE id='" . trim($id) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                $results = $query;
                mysql_close($dbconnection);
                return $results;
	}

	function claim_complaint($moderator,$id){
		global $configfile;
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbcoctable");
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("UPDATE " . trim($dbtable) . " SET moderator='" . trim($moderator) . "' WHERE id='" . trim($id) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
		$results = $query;
                mysql_close($dbconnection);
                return $results;
	}

	function add_abusecomplaint($from,$about,$dtofproblem,$gamenumber,$summary,$message,$screenshoturl){
		global $configfile;
		$results = "unknown";
		if (empty($from)){ $results = "failed, from user name can not be blank"; return $results; exit; }
		if (empty($about)){ $results = "failed, about user name can not be blank"; return $results; exit; }
		if (empty($dtofproblem)){ $results = "failed, date / time of problem can not be blank"; return results; exit; }
		if (empty($summary)){ $results = "failed, summary can not be blank"; return $results; exit; }
		if (empty($message)){ $results = "failed, message can not be blank"; return $results; exit; }
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
		$dbcoctable = get_config_value($configfile,"dbcoctable");
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($dbcoctable)){ $results = "failed, database cockatrice code of conduct report table can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT name FROM " . trim($dbtable) . " WHERE name='" . trim($about) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
		$row = mysql_fetch_array($query);
		if (strtolower(trim($about)) == strtolower(trim($row['name']))){ $reguser = "1"; } else { $reguser = "0"; }
		$query = mysql_query("INSERT into " . trim($dbcoctable) . " (userfrom,userabout,aboutreguser,dtofproblem,gamenumber,briefdescription,message,datereported,screenshoturl) VALUES ('" . mysql_real_escape_string(trim($from)) . "','" . mysql_real_escape_string(trim($about)) . "','" . mysql_real_escape_string($reguser) . "','" . mysql_real_escape_string(trim(mysql_real_escape_string($dtofproblem))) . "','" . mysql_real_escape_string(trim($gamenumber)) . "','" . mysql_real_escape_string(trim(mysql_real_escape_string($summary))) . "','" . trim(mysql_real_escape_string($message)) . "','" . date("Y-m-d H:i:s") . "','" . trim(mysql_real_escape_string($screenshoturl)) . "')");
		$results = $query;
		mysql_close($dbconnection);
		return $results;	
	}

	function send_email($username,$subject,$message){
		global $configfile;
                $results = "unknown";
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($subject)){ $results = "failed, subject can not be blank"; return $results; exit; }
		if (empty($message)){ $results = "failed, message can not be blank"; return $results; exit; }
		$usersemailaddress = get_user_data($username,"email");
		if (!empty($usersemailaddress)){
			$message = wordwrap($message, 70, "\r\n");
			$results = mail($usersemailaddress,$subject,$message);
		} else {
			$results = "warning, user does not have an email address associated with account";
		}
		return $results;
	}
	
	function get_registered_usercount()
	{
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
		$dbusername = get_config_value($configfile,"dbusername");
		$dbpassword = get_config_value($configfile,"dbpassword");
		$dbname = get_config_value($configfile,"dbname");
		$dbtable = get_config_value($configfile,"dbusertable");
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
		if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
		if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
		if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
		if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		$query = mysql_query("SELECT count(*) FROM " . trim($dbtable));
		if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
		while ($row = mysql_fetch_array($query)){ $results = $row['count(*)']; }
		mysql_close($dbconnection);
		return $results;	
	}

	function locate_username_byid($userid){
		global $configfile;
                $results = "unknown";
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
                if (empty($userid)){ $results = "failed, user id can not be blank"; return $results; exit; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT * FROM " . trim($dbtable) . " WHERE id='" . trim($userid) . "'");
		if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                $row = mysql_fetch_array($query);
		$results = $row['name'];
		mysql_close($dbconnection);
                return $results;
	}

	function get_user_data($username,$datatocollect){
		global $configfile;
                $results = "unknown";
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($datatocollect)){ $results = "failed, user data to collect can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT * FROM " . trim($dbtable) . " WHERE name='" . trim($username) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                $row = mysql_fetch_array($query);
		switch (strtolower(trim($datatocollect))){
			case 'id':
				$results = $row['id'];
				break;
			case 'admin':
				$results = $row['admin'];
				break;
			case 'name':
				$results = $row['name'];
				break;
			case 'realname':
				$results = $row['realname'];
				break;
			case 'gender':
				$results = $row['gender'];
				break;
			case 'password_sha512':
				$results = $row['password_sha512'];
				break;
			case 'email':
				$results = $row['email'];
				break;
			case 'country':
				$results = $row['country'];
				break;
			case 'avatar_bmp':
				$results = $row['avatar_bmp'];
				break;
			case 'registrationdate':
				$results = $row['registrationDate'];
				break;
			case 'active':
				$results = $row['active'];
				break;
			case 'token':
				$results = $row['token'];
				break;
			default:
				$results = "failed, unknown user data type to collect";
				return $results;
				exit;
		}
		mysql_close($dbconnection);
		return $results;
	}

	function add_user($username,$password){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
		$dbusername = get_config_value($configfile,"dbusername");
		$dbpassword = get_config_value($configfile,"dbpassword");
		$dbname = get_config_value($configfile,"dbname");
		$dbtable = get_config_value($configfile,"dbusertable");
		$encryptedpassword = crypt_password($password,'');
		$registrationdate = date("Y-m-d H:i:s");
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($password)){ $results = "failed, password can not be blank"; return $results; exit; }
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
		if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
		if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
		if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($registrationdate)){ $results = "failed, registration date can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		$query = mysql_query("INSERT INTO " . trim($dbtable) . " (name,password_sha512,active,registrationDate) VALUES ('" . mysql_real_escape_string(trim($username)) . "','" . trim($encryptedpassword) . "',1,'" . $registrationdate . "')");
		if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
		mysql_close($dbconnection);
		return $results;
	}

	function delete_user($username){
		global $configfile;
                $results = "unknown";
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
		if (empty($username)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
		if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("DELETE FROM " . trim($dbtable) . " WHERE name='" . trim($username) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;	
	}

	function update_user_table($username,$tablecolumn,$tablecolumnvalue){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbusertable");
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($tablecolumn)){ $results = "failed, table column name can not be blank"; return $results; exit; }
		if (strtolower($tablecolumn) == "password_sha512"){ $tablecolumnvalue = crypt_password($tablecolumnvalue,''); }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
		if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		if (strtolower($tablecolumn) == "country") { $tablecolumnvalue = strtolower($tablecolumnvalue); }
		if (strtolower($tablecolumn) == "gender") { $tablecolumnvalue = strtolower($tablecolumnvalue); }
                $query = mysql_query("UPDATE " . trim($dbtable) . " SET " . trim($tablecolumn) . "='" . mysql_real_escape_string(trim($tablecolumnvalue)) . "' WHERE name='" . trim($username) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;
	}
	
	function add_ban($username,$ipaddress,$modname,$starttime,$duration,$reason,$displayreason){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbusertable = get_config_value($configfile,"dbusertable");
		$dbtable = get_config_value($configfile,"dbbantable");
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($ipaddress)){ $results = "failed, ip address can not be blank"; return $results; exit; }
		if (empty($modname)){ $results = "failed, moderator name can not be blank"; return $results; exit; }
		if (empty($starttime)){ $starttime = date("Y-m-d H:i:s"); }
		if (empty($duration)){ $results = "failed, duration can not be blank"; return $results; exit; }
		if (empty($reason)){ $results = "failed, reason can not be blank"; return $results; exit; }
		if (empty($displayreason)){ $displayreason = $reason; }
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($dbusertable)){ $results = "failed, database user table name can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		$query = mysql_query("SELECT id FROM " . $dbusertable . " WHERE name='" . $modname . "'");
		$row = mysql_fetch_array($query);
		if (!$row){ $results = "failed, moderator not found"; return $results; exit; }
		$adminid = $row['id'];
                $query = mysql_query("INSERT INTO " . trim($dbtable) . "(user_name,ip_address,id_admin,time_from,minutes,reason,visible_reason) VALUES ('" . $username . "','" . $ipaddress . "','" . $adminid . "','" . $starttime . "'," . $duration . ",'" . mysql_real_escape_string($reason) . "','" . mysql_real_escape_string($displayreason) . "')");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
		return $results;
	}

	function delete_ban($username,$timestamp){
		global $configfile;
                $results = "unknown";
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
		$dbtable = get_config_value($configfile,"dbbantable");
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($timestamp)){ $results = "failed, time stamp can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		if (trim(strtolower($timestamp)) == "all"){
			$query = mysql_query("DELETE FROM " . trim($dbtable) . " WHERE user_name='" . trim($username) . "'");
		} else {
			$query = mysql_query("DELETE FROM " . trim($dbtable) . " WHERE user_name='" . trim($username) . "' AND time_from='" . $timestamp . "'");
		}
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;
	}

	function add_servermessage($serverid,$timestamp,$message){
		global $configfile;
                $results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbmessagetable");
		if (empty($serverid)){ $serverid = get_config_value($configfile,"serverid"); }
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($serverid)){ $results = "failed, id of server can not be blank"; return $results; exit; }
		if (empty($message)){ $results = "failed, server message can not be blank"; return $results; exit; }
		if (empty($timestamp)){ $timestamp = date("Y-m-d H:i:s"); }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("INSERT INTO " . trim($dbtable) . " (id_server,timest,message) VALUES (" . trim($serverid) . ",'" . trim($timestamp) . "','" . trim(mysql_real_escape_string($message)) . "')");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;
	}

	function delete_servermessage($serverid,$timestamp){
		global $configfile;
                $results = "unknown";
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbmessagetable");
                if (empty($id)){ $serverid = get_config_value($configfile,"serverid"); }
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                if (empty($timestamp)){ $results = "failed, time stamp can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("DELETE FROM " . trim($dbtable) . " WHERE timest='" . trim($timestamp) . "'");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;
	}
	
	function delete_dbrows($count,$dbtable){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
         	$dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                if (empty($count)){ $results = "failed, number of rows to delete can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                if (trim(strtolower($count)) == "all"){
                	$query = mysql_query("DELETE FROM " . trim($dbtable));
                } else {
	                $query = mysql_query("DELETE FROM " . trim($dbtable) . " limit " . $count);
	        }
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                mysql_close($dbconnection);
                return $results;
	}
	
	function get_playercount(){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
            	$dbusername = get_config_value($configfile,"dbusername");
              	$dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbsessiontable");
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
               	if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
             	if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
             	$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT count(*) FROM " . trim($dbtable) . " WHERE end_time IS NULL");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                while ($row = mysql_fetch_array($query)){ $results = $row['count(*)']; }
                mysql_close($dbconnection);
                return $results;
	}

	function get_modcount(){
		global $configfile;
                $results = "unknown";
		$count = 0;
                $dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbsessiontable");
		$dbusertable = get_config_value($configfile,"dbusertable");
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		if (empty($dbusertable)){ $results = "failed, database users table can not be blank"; return results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT name  FROM " . trim($dbusertable) . " WHERE admin != 0");
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                while ($row = mysql_fetch_array($query)){
			$query2 = mysql_query("SELECT * FROM " . trim($dbtable) . " WHERE user_name = '" . $row['name'] . "' AND end_time is NULL");
			while ($row2 = mysql_fetch_array($query2)){ $count = $count + 1; }
		}
                mysql_close($dbconnection);
                $results = $count;
		return $results;
	}
	
	function get_replaycount(){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
                $dbusername = get_config_value($configfile,"dbusername");
                $dbpassword = get_config_value($configfile,"dbpassword");
                $dbname = get_config_value($configfile,"dbname");
                $dbtable = get_config_value($configfile,"dbreplaytable");
                if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
                if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
                if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
                if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
                if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
                $dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
                if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
                $query = mysql_query("SELECT count(*) FROM " . trim($dbtable));
                if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
                while ($row = mysql_fetch_array($query)){ $results = $row['count(*)']; }
                mysql_close($dbconnection);
                return $results;
	}
	
	function get_uptimedatacount(){
		global $configfile;
		$results = "unknown";
		$dbserver = get_config_value($configfile,"dbserver");
		$dbusername = get_config_value($configfile,"dbusername");
		$dbpassword = get_config_value($configfile,"dbpassword");
		$dbname = get_config_value($configfile,"dbname");
		$dbtable = get_config_value($configfile,"dbuptimetable");
		if (empty($dbserver)){ $results = "failed, database server can not be blank"; return $results; exit; }
		if (empty($dbusername)){ $results = "failed, database user name can not be blank"; return $results; exit; }
		if (empty($dbpassword)){ $results = "failed, database user name password can not be blank"; return $results; exit; }
		if (empty($dbname)){ $results = "failed, database name can not be blank"; return $results; exit; }
		if (empty($dbtable)){ $results = "failed, database table name can not be blank"; return $results; exit; }
		$dbconnection = connect_to_database($dbserver,$dbusername,$dbpassword,$dbname);
		if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		$query = mysql_query("SELECT count(*) FROM " . trim($dbtable));
		if ($query){ $results = "success"; } else { $results = "failed, " . mysql_error(); }
		while ($row = mysql_fetch_array($query)){ $results = $row['count(*)']; }
		mysql_close($dbconnection);
		return $results;	
	}


	function get_session_data($username,$data,$state){
		global $configfile;
		$results = "unknown";
		if (empty($username)){ $results = "failed, user name can not be blank"; return $results; exit; }
		if (empty($data)){ $results = "failed, data to collect can not be blank"; return $results; exit; }
		if (empty($state)){ $state = "offline"; }
		$dbserv = get_config_value($configfile,"dbserver");
		if (strpos(strtolower($dbserver),"fail") !== false){ $results = strtolower($dbserver); return $results; exit; }
		$dbuser = get_config_value($configfile,"dbusername");
		if (strpos(strtolower($dbuser),"fail") !== false){ $results = strtolower($dbuser); return $results; exit; }
		$dbpass = get_config_value($configfile,"dbpassword");
		if (strpos(strtolower($dbpass),"fail") !== false){ $results = strtolower($dbpass); return $results; exit; }
		$dbname = get_config_value($configfile,"dbname");
		if (strpos(strtolower($dbname),"fail") !== false){ $results = strtolower($dbname); return $results; exit; }
		$dbtable = get_config_value($configfile,"dbsessiontable");
		if (strpos(strtolower($dbtable),"fail") !== false){ $results = strtolower($dbtable); return $results; exit; }
		$dbconnection = connect_to_database($dbserv,$dbuser,$dbpass,$dbname);
		if (strpos(strtolower($dbconnection),"fail") !== false){ $results = strtolower($dbconnection); return $results; exit; }
		$query = mysql_query("SELECT * from " . $dbtable  . " where user_name='" . $username . "' ORDER BY id DESC limit 1");
		if (!query){ $results = "failed, " . mysql_error(); return $results; exit; }
		$row = mysql_fetch_array($query);
		if (!row){ $results = "failed, unable to locate user session data information (UserNotLoggedIn)"; return $results; exit; }
		switch (strtolower($data)){
			case 'id':
				$results = $row['id'];
				break;
                        case 'user_name':
                                $results = $row['user_name'];
                                break;
                        case 'id_server':
                                $results = $row['id_server'];
                                break;
                        case 'ip_address':
                                $results = $row['ip_address'];
                                break;
                        case 'start_time':
                                $results = $row['start_time'];
                                break;
                        case 'end_time':
                                $results = $row['end_time'];
                                break;
                        default:
                                $results = 'Failed, unknown database user data type ' . $datatocollect;
                }
                mysql_close($dbconnection);
                return $results;
	}

?>
